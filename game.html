<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>History</title>

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  font-family: system-ui, sans-serif;
  color: white;
}

/* Background */
.bg {
  position: fixed;
  inset: 0;
  z-index: 0;
  background-image:
    linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px),
    linear-gradient(to bottom, #0b0b2b, #1b2735 70%, #090a0f);
  background-size: 40px 40px, 40px 40px, cover;
}

html, body {
  overflow: hidden;
}

::-webkit-scrollbar {
  display: none;
}


/* Fullscreen iframe */
iframe {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  border: none;
  display: none;
  z-index: 1;
}

/* UI Layer */
.viewer {
  position: fixed;
  inset: 0;
  z-index: 2;
}

.viewer :hover{
  filter: brightness(100%);
}
/* Play button */
#playBtn {
  position: absolute;
  inset: 0;
  margin: auto;
  width: fit-content;
  height: fit-content;
  padding: 26px 56px;
  font-size: 26px;
  font-weight: 800;
  border-radius: 16px;
  border: none;
  background: linear-gradient(to bottom, #0b0b2b, #090a0f);
  color: #ffffff;
  cursor: pointer;
  z-index: 5;

  /* small upgrades */
  box-shadow: 0 14px 32px rgba(0,0,0,.6);
  transition: transform .2s ease, box-shadow .2s ease;
}

#playBtn:hover {
  transform: scale(1.08);
  box-shadow: 0 20px 45px rgba(0,0,0,.8);
}

#playBtn:active {
  transform: scale(0.96);
}


/* Bottom bar */
.game-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 72px;
  background: #0e1b1b;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  z-index: 4;
}

.game-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.game-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: linear-gradient(135deg, #6a5acd, #8a2be2);
}

.game-text {
  display: flex;
  flex-direction: column;
}

.game-right {
  display: flex;
  gap: 12px;
  font-size: 30px;
}

.game-right button {
  background: transparent;
  border: none;
  cursor: pointer;
}

/* Sidebar */
.side-bar {
  position: fixed;
  right: 24px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  flex-direction: column;
  gap: 16px;
  z-index: 6;
}

.side-bar button {
  width: 52px;
  height: 52px;
  border-radius: 14px;
  border: none;
  background: #132727;
  cursor: pointer;
  transition: transform .25s, filter .25s;
}

.side-bar button:hover{
    filter: brightness(.6);
    transform: scale(1.2);
  }

</style>
</head>

<body>

<div class="bg"></div>

<iframe id="gameFrame"></iframe>

<div class="viewer">
    <button id="playBtn" onclick="playGame()">â–¶ PLAY GAME</button>
</div>

<div class="game-bar">
  <div class="game-left">

  <div class="game-right">
    <b>By Cementful</b>
    <button onclick="reloadGame()"><img src="https://cdn.jsdelivr.net/gh/Just4N0bdy/Webiste@main/Reload.png"></button>
    <button onclick="fullscreen()"><img src="https://cdn.jsdelivr.net/gh/Just4N0bdy/Webiste@main/fullscreen.png"></button>
  </div>
</div>

<div class="side-bar">
  <button><a href="index.html"><img src="home.png"></a></button>
  <button><a href="index.html"><img src="https://cdn.jsdelivr.net/gh/Just4N0bdy/Random-Stuff@main/gameicon2.png"></a></button>
  <button><a href="apps.html"><img src="Apps.png"></a></button>
  <button><a href="index.html"><img src="settings.png"></a></button>
</div>

<script>
const FILE_URL = sessionStorage.getItem("gameUrl"); // jsDelivr URL
const frame = document.getElementById("gameFrame");

const DB_NAME = "GameCacheDB";
const STORE_NAME = "GameFiles";
const CACHE_DURATION = 90 * 24 * 60 * 60 * 1000;

function openDB() {
  return new Promise(res => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e =>
      e.target.result.createObjectStore(STORE_NAME, { keyPath: "url" });
    req.onsuccess = e => res(e.target.result);
  });
}

async function getFile(url) {
  const db = await openDB();
  return new Promise(async (resolve, reject) => {
    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(url);

    req.onsuccess = async () => {
      const data = req.result;
      if (data && Date.now() - data.timestamp < CACHE_DURATION) {
        resolve(data.content);1
      } else {
        try {
          const r = await fetch(url);
          const t = await r.text();
          const wtx = db.transaction(STORE_NAME, "readwrite");
          wtx.objectStore(STORE_NAME).put({
            url,
            content: t,
            timestamp: Date.now()
          });
          resolve(t);
        } catch (e) {
          reject(e);
        }
      }
    };
    });
}

function playGame() {
  document.getElementById("playBtn").style.display = "none";
  frame.style.display = "block";

  getFile(FILE_URL)
    .then(html => {
      const baseUrl = FILE_URL.substring(0, FILE_URL.lastIndexOf('/') + 1);
      
      // Parse the HTML
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // Check if <base> already exists
      let baseExists = doc.querySelector('base');
      if (!baseExists) {
        const base = doc.createElement('base');
        base.href = baseUrl;
        
        // Insert into <head> if it exists, otherwise prepend to document
        if (doc.head) {
          doc.head.insertBefore(base, doc.head.firstChild);
        } else {
          doc.documentElement.insertBefore(base, doc.documentElement.firstChild);
        }
        console.log(`Added <base> tag for ${FILE_URL}`); // For debugging
      } else {
        console.log(`<base> tag already exists for ${FILE_URL}, skipping addition.`); // For debugging
      }
      
      // Set srcdoc to the modified HTML
      frame.srcdoc = doc.documentElement.outerHTML;
    })
    .catch((e) => {
      console.error("Failed to load game:", e);
      alert("Failed to load game. Check console for details.");
    });
}

function fullscreen() {
  frame.requestFullscreen();
}
</script>

</body>
</html>
